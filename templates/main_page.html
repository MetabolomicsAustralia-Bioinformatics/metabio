{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%} ">
    <link rel="stylesheet" href="{% static 'css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main_page.css' %}">
    <meta charset="UTF-8">
    <script type="text/javascript" src="../static/js/echarts.js"></script>
    <script type="text/javascript" src="../static/js/jquery-3.2.1.js"></script>
    <script type="text/javascript" src="../static/js/ecStat.js"></script>
    <script type="text/javascript" src="../static/js/regression.js"></script>
    <title>Title</title>
</head>
<body>


    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light navbar-static-top" id="main_page_nav">
        <img src="{% static 'img/main_icon.png'%}">

        <a>Web based concentration calculation tool</a>

    </nav>


    <div class="container-fluid">
        <div class="row-fluid">
            <div class="left">
      <!--边栏内容-->
                <div class="form-group">
                    <!--<span class="h3">upload file</span>-->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <p>
                        <label for="id_upload_form"></label>
                        <input type="file" name="upload_form" required id="id_upload_form" />
                        </p>
                        <input type="submit" class="btn btn-success pull-right" value="upload">

                    </form>
                    {% if typeError %}
                            <p> invalid file !</p>
                        {% endif %}

                </div>

                <form name="download_sample" method="post">
                    {% csrf_token %}
                    <input type="text" value="download_sample" name="download_sample" style="display: none">
                    <input type="submit" id="download_sample" value="download sample file" class="btn btn-warning">
                </form>
                {% if show_result %}
                    <input type="button" id="show_result" value="show result" class="btn btn-danger">
                </form>
                {% endif %}


            </div>
            <div class="right" style="color: #1b1e21">

                {% if not graph %}
                    <h1 class="introduction_text">Introduction</h1>
                    <h2 class="introduction_text">lorem epsum</h2>
                     <form name="try" method="post">
                    {% csrf_token %}
                    <input type="text" value="try" name="try" style="display: none">
                    <input type="submit" value="try it out !" class="btn btn-warning">
                {% endif %}

                {% if graph %}
                    <!--
                    <div class="container">
                        <div class="row">
                            <div class="col-md-2 offset-6">
                                <select id="dataX" class="custom-select">
                                    <option value="Concentration">Concentration</option>
                                    <option value="IS">IS</option>
                                    <option value="Acetate">Acetate</option>
                                    <option value="Propionate">Propionate</option>
                                    <option value="Isobutyrate">Isobutyrate</option>
                                    <option value="Butyrate">Bytyrate</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="dataY" class="custom-select">
                                    <option value="IS">IS</option>
                                    <option value="Concentration">Concentration</option>
                                    <option value="Acetate">Acetate</option>
                                    <option value="Propionate">Propionate</option>
                                    <option value="Isobutyrate">Isobutyrate</option>
                                    <option value="Butyrate">Bytyrate</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    -->

                    <div id="chart" style="width: 800px; height: 400px; margin-left: auto; margin-right: auto"></div>
                    <script type="text/javascript">
                        var myChart = echarts.init(document.getElementById('chart'), '', {devicePixelRatio: 2});
                        var selected = {};
                        var hData = [];
                        var vData = [];
                        var two_dimen_data = [];
                        var option;

                        myChart.on('click', function(para) {
                            var origin_index = hData[para.dataIndex][0];
                            if (!selected.hasOwnProperty(origin_index)) {
                                selected[origin_index] = true;
                            }
                            else {
                                selected[origin_index] = !selected[origin_index];
                            }
                            var tmp = [];
                            for (var i = 0; i < hData.length; i++) {
                                if (!selected.hasOwnProperty(hData[i][0]) || !selected[hData[i][0]]) {
                                    tmp.push([hData[i][1], vData[i]]);
                                }
                            }
                            two_dimen_data = tmp;
                            option = get_option(hData, vData, two_dimen_data, selected);
                            myChart.setOption(option);

                        });
                        $('#show_result').on('click', function() {
                            console.log(selected);
                            $.ajax({
                                type: 'POST',
                                async: true,
                                traditional: true,
                                url: '../show_result/',
                                dataType: 'json',
                                data: {'selected': JSON.stringify(selected),
                                        'input_json_pk': {{ input_json_pk }},
                                        'csrfmiddlewaretoken': '{{ csrf_token }}'},
                                success: function(result) {
                                    window.sessionStorage.setItem("result_data", JSON.stringify(result));
                                    window.sessionStorage.setItem('selected', JSON.stringify(selected));
                                    window.sessionStorage.setItem('input_json_pk', {{ input_json_pk }});
                                    window.location.href = './result_page/';


                                },
                                error: function() {alert('can not show result!!!')}
                            })
                        });

                        $(function () {
                            var dataX = 'Concentration';
                            var dataY = 'IS';
                            if ('{{ try }}' == 'False'){
                                show_chart(dataX, dataY, hData, vData);}
                            else {
                                show_try_chart(dataX, dataY, hData, vData);
                            }
                        });

                        function get_length(obj) {
                            var size = 0;
                            for (key in obj) {
                                if (obj.hasOwnProperty(key)) {
                                    size ++;
                                }
                            }
                            return size;
                        }
                        function sortXAxis(dataX, dataY) {
                            var tmp = new Array();
                            for (var i = 0; i < dataX.length; i++) {
                                dataX[i] = [i, dataX[i]];
                                tmp[i] = dataY[i];
                            }
                            dataX.sort(sortArr);
                            for (var j = 0; j < dataY.length; j++) {
                                dataY[j] = tmp[dataX[j][0]];
                            }
                        }
                        function sortArr(m, n) {
                            if (m[1] < n[1]) {
                                return -1;
                            }
                            else if (m[1] > n[1]) {
                                return 1;
                            }
                            else return 0;
                        }
                        function filter_selected_data(hData, vData, selected) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                if (selected[hData[i][0]] == true) {
                                    res.push('-');
                                }
                                else {
                                    res.push(vData[i]);
                                }
                            }
                            return res;
                        }
                        function filter_unselected_data(hData, vData, selected) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                if (selected[hData[i][0]] == true){
                                    res.push(vData[i]);
                                }
                                else {
                                    res.push('-');
                                }
                            }
                            return res;
                        }
                        function get_clear_hData(hData) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                res.push(hData[i][1]);
                            }
                            return res;
                        }
                        function get_option(hData, vData, two_dimen_data, selected) {
                            var myRegression = regression.linear(two_dimen_data);
                            var regression_points = [];
                            var k = myRegression.equation[0];
                            var b = myRegression.equation[1];
                            var clear_hData = get_clear_hData(hData);

                            for (var i = 0; i < clear_hData.length; i++) {
                                regression_points.push(k * clear_hData[i] + b);
                            }
                            var option = {
                            title: {
                                text: ''
                            },

                            xAxis: {
                                name: 'Concentration',
                                type: 'category',
                                boundaryGap: false,
                                data: get_clear_hData(hData)

                            },
                            yAxis: {
                                name: 'IS',
                                type: 'value'
                            },
                            /*
                            dataZoom: {
                                show: true,
                                realtime: true,
                                height: 20
                            },
                            */
                            series: [{
                                name: 'Concentration',
                                type: 'scatter',
                                data: [],
                                itemStyle: {
                                    normal: {
                                        color: '#d94e5d'
                                    }
                                }

                            },
                                {
                                name: 'Concentration',
                                type: 'scatter',
                                data: [],
                                itemStyle: {
                                    normal: {
                                        color: '#eac736'
                                    }
                                }

                                },


                               {
                                name: 'line',
                                type: 'line',
                                showSymbol: false,
                                data: myRegression.points,
                                markPoint: {
                                    itemStyle: {
                                        normal: {
                                            color: 'transparent'
                                        }
                                    },
                                    label: {
                                        normal: {
                                            show: true,
                                            position: 'left',
                                            formatter: myRegression.string,
                                            textStyle: {
                                                color: '#333',
                                                fontSize: 14
                                            }
                                        }
                                    },
                                    data: [{
                                        coord: myRegression.points[myRegression.points.length - 1]
                                    }]
                                }
                            }


                            ],
                            tooltip: {
                                trigger: 'item',
                                triggerOn: 'mousemove',
                                //showContent: true,
                                formatter: function (para) {
                                    return option.xAxis.name + '  :  ' + para.name + '<br/>'
                                         + option.yAxis.name + '  :  ' + para.data + '<br/>';
                                }
                                }
                            };
                            option.series[0].data = filter_selected_data(hData, vData, selected);
                            option.series[1].data = filter_unselected_data(hData, vData, selected);
                            return option;
                        }
                        function draw_chart(originData, dataX, dataY, hData, vData) {
                            myChart.showLoading();
                                for (var i = 0; i < get_length(originData[dataX]); i++) {
                                    if (originData['Group'][i] == 'S'){
                                        hData.push(originData[dataX][i]);
                                    }
                                }
                                for (var j = 0; j < get_length(originData[dataY]); j++) {
                                    if (originData['Group'][j] == 'S') {
                                        vData.push(originData[dataY][j]);
                                    }
                                }

                                sortXAxis(hData, vData);
                                for (var k = 0; k < hData.length; k++) {
                                    if (!selected.hasOwnProperty(hData[k][0]) || !selected[hData[k][1]]){
                                        two_dimen_data.push([hData[k][1], vData[k]]);
                                    }
                                }
                                option = get_option(hData, vData, two_dimen_data, selected);
                                myChart.hideLoading();
                                myChart.setOption(option);
                        }
                        function show_chart(dataX, dataY, hData, vData) {
                            $.ajax({
                                type: 'GET',
                                async: true,
                                url: '../show_graph',
                                dataType: 'json',
                                data: {
                                    'input_json_pk': {{ input_json_pk }}
                                },
                                success: function(originData) {
                                    draw_chart(originData, dataX, dataY, hData, vData);
                                    },
                                error: function() {
                                    alert('error!')
                                }
                            })
                        }
                        function show_try_chart(dataX, dataY, hData, vData) {
                            $.ajax({
                                   type: 'POST',
                                   async: true,
                                   url: '../show_try_graph',
                                   dataType: 'json',
                                   data: {"try": 'true',
                                       'csrfmiddlewaretoken': '{{ csrf_token }}'},
                                   success: function(originData) {
                                       draw_chart(originData, dataX, dataY, hData, vData);
                                       $('#download_sample').click();
                                   },
                                   error: function() {alert("try error!")}
                               })
                        }
                    </script>
                {% endif %}
            </div>
        </div>
    </div>



    <nav class="navbar fixed-bottom navbar-light bg-light">
        <a class="navbar-brand" href="#">Contact: Dr. Saravanan Dayalan, sdayalan@unimelb.edu.au</a>
    </nav>



    <script type="text/javascript">
    </script>
</body>
</html>