{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%} ">
    <link rel="stylesheet" href="{% static 'css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main_page.css' %}">
    <meta charset="UTF-8">
    <script type="text/javascript" src="../static/js/echarts.js"></script>
    <script type="text/javascript" src="../static/js/jquery-3.2.1.js"></script>
    <title>Title</title>
</head>
<body>


    <nav class="navbar fixed-top navbar-expand-lg navbar-light bg-light navbar-static-top" id="main_page_nav">
        <img src="{% static 'img/main_icon.png'%}">

        <a>Web based concentration calculation tool</a>

    </nav>


    <div class="container-fluid">
        <div class="row-fluid">
            <div class="left">
      <!--边栏内容-->
                <div class="form-group">
                    <!--<span class="h3">upload file</span>-->
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <p>
                        <label for="id_upload_form"></label>
                        <input type="file" name="upload_form" required id="id_upload_form" />
                        </p>
                        <input type="submit" class="btn btn-success pull-right" value="upload">

                    </form>
                    {% if typeError %}
                            <p> invalid file !</p>
                        {% endif %}

                </div>

                <form name="download_sample" method="post">
                    {% csrf_token %}
                    <input type="text" value="download_sample" name="download_sample" style="display: none">
                    <input type="submit" value="download sample file" class="btn btn-warning">
                </form>
                {% if show_result %}
                    <input type="button" id="show_result" class="btn btn-danger" value="show result">
                {% endif %}


            </div>
            <div class="right" style="color: #1b1e21">

                {% if not graph %}
                    <h1 class="introduction_text">Introduction</h1>
                    <h2 class="introduction_text">lorem epsum</h2>
                {% endif %}

                {% if graph %}
                    <div class="container">
                        <div class="row">
                            <div class="col-md-2 offset-6">
                                <select id="dataX" class="custom-select">
                                    <option value="IS">IS</option>
                                    <option value="Concentration">Concentration</option>
                                    <option value="Acetate">Acetate</option>
                                    <option value="Propionate">Propionate</option>
                                    <option value="Isobutyrate">Isobutyrate</option>
                                    <option value="Butyrate">Bytyrate</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select id="dataY" class="custom-select">
                                    <option value="Concentration">Concentration</option>
                                    <option value="IS">IS</option>
                                    <option value="Acetate">Acetate</option>
                                    <option value="Propionate">Propionate</option>
                                    <option value="Isobutyrate">Isobutyrate</option>
                                    <option value="Butyrate">Bytyrate</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div id="chart" style="width: 800px; height: 400px; margin-left: auto; margin-right: auto"></div>
                    <script type="text/javascript">
                        var myChart = echarts.init(document.getElementById('chart'));
                        var selected = {};
                        var hData = [];
                        var vData = [];
                        var option;

                        myChart.on('click', function(para) {
                                        var origin_index = hData[para.dataIndex][0];
                                        if (!selected.hasOwnProperty(origin_index)) {
                                            selected[origin_index] = true;
                                        }
                                        else {
                                            selected[origin_index] = !selected[origin_index];
                                        }
                                        option = get_option(hData, vData, selected);
                                        myChart.setOption(option);

                                    });

                        $(function () {
                            //var dataX = 'IS';
                            //var dataY = 'Concentration';
                            var dataX = $('#dataX').val();
                            var dataY = $('#dataY').val();
                            show_chart(dataX, dataY, hData, vData);

                            $('#dataX').on('change', function() {
                                hData = [];
                                vData = [];
                                dataX = $(this).val();
                                show_chart(dataX, dataY, hData, vData);
                            });
                            $('#dataY').on('change', function() {
                                hData = [];
                                vData = [];
                                dataY = $(this).val();
                                show_chart(dataX, dataY, hData, vData);
                            });
                            $('#show_result').on('click', function() {
                                console.log(selected);
                                $.ajax({
                                    type: 'POST',
                                    async: true,
                                    traditional: true,
                                    url: '../show_result/',
                                    dataType: 'json',
                                    data: {'selected': JSON.stringify(selected),
                                            'input_json_pk': {{ input_json_pk }},
                                            'csrfmiddlewaretoken': '{{ csrf_token }}'},
                                    success: function(result) {
                                        //var new_window = window.open("./test_page.html");
                                        //new_window.result_data = result;
                                        window.sessionStorage.setItem("result_data", JSON.stringify(result));
                                        window.location.href = './result_page/';


                                    },
                                    error: function() {alert('can not show result!!!')}
                                })
                            })
                        });

                        function get_length(obj) {
                            var size = 0;
                            for (key in obj) {
                                if (obj.hasOwnProperty(key)) {
                                    size ++;
                                }
                            }
                            return size;
                        }
                        function sortXAxis(dataX, dataY) {
                            var tmp = new Array();
                            for (var i = 0; i < dataX.length; i++) {
                                dataX[i] = [i, dataX[i]];
                                tmp[i] = dataY[i];
                            }
                            dataX.sort(sortArr);
                            for (var j = 0; j < dataY.length; j++) {
                                dataY[j] = tmp[dataX[j][0]];
                            }
                        }
                        function sortArr(m, n) {
                            if (m[1] < n[1]) {
                                return -1;
                            }
                            else if (m[1] > n[1]) {
                                return 1;
                            }
                            else return 0;
                        }
                        function filter_selected_data(hData, vData, selected) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                if (selected[hData[i][0]] == true) {
                                    res.push('-');
                                }
                                else {
                                    res.push(vData[i]);
                                }
                            }
                            return res;
                        }
                        function filter_unselected_data(hData, vData, selected) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                if (selected[hData[i][0]] == true){
                                    res.push(vData[i]);
                                }
                                else {
                                    res.push('-');
                                }
                            }
                            return res;
                        }
                        function get_clear_hData(hData) {
                            var res = [];
                            for (var i = 0; i < hData.length; i++) {
                                res.push(hData[i][1]);
                            }
                            return res;
                        }
                        function get_option(hData, vData, selected) {

                            var option = {
                            title: {
                                text: ''
                            },

                            xAxis: {
                                name: $('#dataX').val(),
                                type: 'category',
                                boundaryGap: false,
                                data: get_clear_hData(hData)

                            },
                            yAxis: {
                                name: $('#dataY').val(),
                                type: 'value'
                            },

                            dataZoom: {
                                show: true,
                                realtime: true,
                                height: 20
                            },

                            series: [{
                                name: 'Concentration',
                                type: 'scatter',
                                data: [],
                                itemStyle: {
                                    normal: {
                                        color: '#d94e5d'
                                    }
                                }
                            },
                                {
                                name: 'Concentration',
                                type: 'scatter',
                                data: [],
                                itemStyle: {
                                    normal: {
                                        color: '#eac736'
                                    }
                                }
                                }
                            ],
                            tooltip: {
                                trigger: 'item',
                                triggerOn: 'mousemove',
                                //showContent: true,
                                formatter: function (para) {
                                    return option.xAxis.name + ':' + para.name + '<br/>'
                                         + option.yAxis.name + ':' + para.data + '<br/>';
                                }
                                }
                            };
                            option.series[0].data = filter_selected_data(hData, vData, selected);
                            option.series[1].data = filter_unselected_data(hData, vData, selected);
                            return option;
                        }
                        function show_chart(dataX, dataY, hData, vData) {
                            $.ajax({
                                type: 'GET',
                                async: true,
                                url: '../show_graph',
                                dataType: 'json',
                                data: {
                                    'input_json_pk': {{ input_json_pk }}
                                },
                                success: function (originData) {
                                    var index_dict = [];
                                    for (var i = 0; i < get_length(originData[dataX]); i++) {
                                        hData.push(originData[dataX][i]);
                                    }
                                    for (var j = 0; j < get_length(originData[dataY]); j++) {
                                        vData.push(originData[dataY][j]);
                                    }
                                    sortXAxis(hData, vData, index_dict);
                                    console.log(hData[0]);
                                    option = get_option(hData, vData, selected);
                                    myChart.setOption(option);
                                },
                                error: function() {
                                    alert('error!')
                                }
                            })
                        }
                    </script>
                {% endif %}
            </div>
        </div>
    </div>



    <nav class="navbar fixed-bottom navbar-light bg-light">
        <a class="navbar-brand" href="#">Contact: Dr. Saravanan Dayalan, sdayalan@unimelb.edu.au</a>
    </nav>



    <script type="text/javascript">
    </script>
</body>
</html>