
{% load staticfiles %}
<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css'%} ">
    <link rel="stylesheet" href="{% static 'css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/main_page.css' %}">
    <meta charset="UTF-8">
    <script type="text/javascript" src="../static/js/echarts.js"></script>
    <script type="text/javascript" src="../static/js/jquery-3.2.1.js"></script>
    <title>Result</title>
</head>
<body>
<select id="algorithm">
    <!--<option value="IS Normalisation" selected="selected">IS Normalisation</option>-->
    <option value="IS + Reagent Blank Subtraction">IS + Reagent Blank Subtraction</option>
    <option value="IS + Reagent Blank Subtraction + Concentration">IS + Reagent Blank Subtraction + Concentration</option>
</select>

<!--
<select id="dataX">
    <option value="IS">IS</option>
    <option value="Concentration">Concentration</option>
    <option value="Acetate">Acetate</option>
    <option value="Propionate">Propionate</option>
    <option value="Isobutyrate">Isobutyrate</option>
    <option value="Butyrate">Bytyrate</option>

</select>
<select id="dataY">
    <option value="Concentration">Concentration</option>
    <option value="IS">IS</option>
    <option value="Acetate">Acetate</option>
    <option value="Propionate">Propionate</option>
    <option value="Isobutyrate">Isobutyrate</option>
    <option value="Butyrate">Bytyrate</option>

</select>
-->

<div id="chart" style="width: 800px; height: 400px; margin-left: auto; margin-right: auto"></div>
<form name="download_result" method="post" action="../download/">
    {% csrf_token %}
    <input type="text" name="download_result" value="download_result"  style="display: none">
    <input type="text" id="selected_input" name="selected" value="download_sample" style="display: none">
    <input type="text" id="json_pk_input" name="input_json_pk" value="download_sample" style="display: none">
    <input type="submit" value="download sample file" class="btn btn-warning">
</form>

<script type="text/javascript">
    var myChart = echarts.init(document.getElementById('chart'));
    $(function() {
        var result_data = JSON.parse(window.sessionStorage.getItem("result_data"));
        var selected = JSON.parse(window.sessionStorage.getItem("selected"));
        var input_json_pk = JSON.parse(window.sessionStorage.getItem("input_json_pk"));
        var algorithm = $('#algorithm').val();
        var dataX = 'Concentration';
        var dataY = 'IS';
        draw_chart(algorithm, dataX, dataY, result_data);

        $('#selected_input').val(JSON.stringify(selected));
        $('#json_pk_input').val(input_json_pk);

        $('#algorithm').on('change', function() {
            algorithm = $(this).val();
            //alert(algorithm);
            draw_chart(algorithm, dataX, dataY, result_data);
        });
        /*
        $('#dataX').on('change', function() {
            dataX = $(this).val();
            draw_chart(algorithm, dataX, dataY, result_data);
        });
        $('#dataY').on('change', function() {
            dataY = $(this).val();
            draw_chart(algorithm, dataX, dataY, result_data);
        });
        */


    });

    function get_length(obj) {
        var size = 0;
        for (key in obj) {
            if (obj.hasOwnProperty(key)) {
                size ++;
            }
        }
        return size;
    }

    function sortXAxis(dataX, dataY) {
        var tmp = new Array();
        for (var i = 0; i < dataX.length; i++) {
            tmp[dataX[i]] = dataY[i];
        }
        dataX.sort();
        for (var j = 0; j < dataY.length; j++) {
            dataY[j] = tmp[dataX[j]];
        }
    }

    function draw_chart(algorithm, dataX, dataY, originData) {
        var hData = [];
                var vData = [];
                var workbook;
                /*
                if (algorithm == 'IS Normalisation') {
                    workbook = originData[1];
                }
                */
                if (algorithm == 'IS + Reagent Blank Subtraction') {
                    workbook = originData[3];
                }
                else if (algorithm == 'IS + Reagent Blank Subtraction + Concentration') {
                    workbook = originData[5];
                }
                //console.log(get_length(workbook[dataX]));
                for (var i = 0; i < get_length(workbook[dataX]); i++) {
                    if (workbook['Group'][i] == 'S') {
                        hData.push(workbook[dataX][i]);
                    }
                    //console.log(hData);
                }
                for (var j = 0; j < get_length(workbook[dataY]); j++) {
                    if (workbook['Group'][j] == 'S') {
                        vData.push(workbook[dataY][j]);
                    }
                    //console.log(vData);
                }

                sortXAxis(hData, vData);

                var option = {
                    title: {
                        text: ''
                    },

                    xAxis: {
                        name: 'Concentration',
                        type: 'category',
                        boundaryGap: false,
                        data: hData
                    },
                    yAxis: {
                        name: 'IS',
                        type: 'value'
                    },
                    series: [{
                        name: 'Concentration',
                        type: 'scatter',
                        data: vData
                    }],
                    tooltip: {
                        trigger: 'item',
                        triggerOn: 'mousemove',
                        //showContent: true,
                        formatter: function (para) {
                            return option.xAxis.name + '  :  ' + para.name + '<br/>'
                                 + option.yAxis.name + '  :  ' + para.data + '<br/>';
                        }
                        }
                };

                myChart.setOption(option);

    }

                    </script>
</body>
</html>